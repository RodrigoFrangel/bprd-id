<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B.P.R.D. ID</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@700&family=Special+Elite&family=Libre+Barcode+39+Text&display=swap" rel="stylesheet">
    <style>
        body { background-color: #1a1a1a; }
        .id-card-body { font-family: 'Roboto Condensed', sans-serif; }
        .id-card { background-color: #f5f5f5; box-shadow: 0 10px 25px rgba(0,0,0,0.5); width: 350px; border: 1px solid #999; position: relative; }
        .id-card .watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.08; pointer-events: none; width: 80%; }
        .header-bar { background-color: #0d3d6f; }
        .header-title { font-family: 'Roboto Condensed', sans-serif; font-weight: 700; letter-spacing: 0.2em; }
        .profile-pic { object-fit: cover; object-position: center; }
        .id-card .data-field { border-top: 1px solid #ccc; padding: 4px 8px; }
        .id-card .data-label { font-weight: 700; color: #555; text-transform: uppercase; }
        .id-card .data-value { font-family: 'Special Elite', monospace; font-size: 1.25rem; color: #000; }
        .attribute-value { font-family: 'Special Elite', monospace; font-size: 0.9rem; font-weight: bold; }
        .font-barcode { font-family: 'Libre Barcode 39 Text', cursive; line-height: 1; }
        .hellboy-body { font-family: 'Special Elite', monospace; }
        .hellboy-card { background-color: #f3f0e6; border: 1px solid #4a4a4a; box-shadow: 5px 5px 15px rgba(0,0,0,0.5); position: relative; max-width: 55rem; }
        .hellboy-card::before { content: ''; position: absolute; top: 0; left: 0; width: 20px; height: 100%; background-color: #b91c1c; border-right: 2px solid #333; }
        .hellboy-card .watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.05; pointer-events: none; }
        .stamp { border: 4px double #b91c1c; color: #b91c1c; font-size: 1.25rem; font-weight: 700; padding: 0.25rem 1rem; transform: rotate(-8deg); opacity: 0.9; letter-spacing: 2px; }
        .profile-pic-container { border: 4px solid #333; background-color: #4a4a4a; padding: 4px; }
        .hellboy-card .profile-pic { filter: grayscale(80%) sepia(20%); }
        .hellboy-card .data-field { border-bottom: 1px solid rgba(0,0,0,0.2); padding-bottom: 2px; }
        .hellboy-card .data-label { letter-spacing: 1px; color: #555; font-family: 'Roboto Condensed', sans-serif; }
        .hellboy-card .data-value { font-weight: bold; color: #1a1a1a; }
        .font-heading { font-family: 'Roboto Condensed', sans-serif; }
        .btn { font-family: 'Roboto Condensed', sans-serif; letter-spacing: 0.1em; text-transform: uppercase; transition: background-color 0.2s; }
    </style>
</head>
<body class="p-4 sm:p-10 flex flex-col items-center justify-center min-h-screen">

    <div id="card-container" style="display: none;">
        <!-- Card Simples -->
        <div id="simple-view" class="id-card-body">
             <div class="id-card flex flex-col overflow-hidden">
                <img src="https://i.postimg.cc/XNQ858Pv/Background-19.png" alt="B.P.R.D. Watermark" class="watermark" onerror="this.style.display='none'">
                <div class="header-bar px-3 py-1 text-white">
                    <h1 class="header-title text-7xl text-center">B.P.R.D.</h1>
                    <p class="text-xs text-center" style="letter-spacing: 0.11em;">BUREAU FOR PARANORMAL RESEARCH AND DEFENSE</p>
                </div>
                <div class="p-2 border-y-2 border-gray-400 z-10 bg-white/50">
                    <div class="flex items-center pt-2">
                        <div class="w-2/5 px-2">
                            <p class="data-label text-center text-base mb-2">ABILITIES INDEX</p>
                            <div class="space-y-3">
                                <div class="flex justify-between items-baseline"><span class="font-bold text-base">STR</span><span id="s-str" class="attribute-value"></span></div>
                                <div class="flex justify-between items-baseline"><span class="font-bold text-base">CON</span><span id="s-con" class="attribute-value"></span></div>
                                <div class="flex justify-between items-baseline"><span class="font-bold text-base">DEX</span><span id="s-dex" class="attribute-value"></span></div>
                                <div class="flex justify-between items-baseline"><span class="font-bold text-base">INT</span><span id="s-int" class="attribute-value"></span></div>
                                <div class="flex justify-between items-baseline"><span class="font-bold text-base">WIS</span><span id="s-wis" class="attribute-value"></span></div>
                                <div class="flex justify-between items-baseline"><span class="font-bold text-base">CHA</span><span id="s-cha" class="attribute-value"></span></div>
                            </div>
                        </div>
                        <div class="w-3/5 p-1"><div class="border-2 border-gray-600"><img id="s-pic" src="" class="w-full h-auto profile-pic" onerror="this.src='https://placehold.co/150x200/6b7280/ffffff?text=AGENT'"></div></div>
                    </div>
                </div>
                <div class="flex-grow z-10 bg-white/50">
                    <div class="data-field"><p class="data-label text-xs">NAME</p><p id="s-name" class="data-value"></p></div>
                    <div class="data-field"><p class="data-label text-xs">ROLE</p><p id="s-role" class="data-value"></p></div>
                    <div class="flex">
                        <div class="w-4/5 data-field"><p class="data-label text-xs">RECRUITMENT</p><p id="s-recruitment" class="data-value text-red-600" style="font-size: 1rem;"></p></div>
                        <div class="w-1/5 data-field" style="border-left: 1px solid #ccc;"><p class="data-label text-xs">LEVEL</p><p id="s-level" class="data-value text-red-600"></p></div>
                    </div>
                    <div class="data-field text-center py-2"><p id="s-barcode" class="font-barcode text-5xl"></p></div>
                </div>
                <a href="#" onclick="toggleView(event)" class="block w-full bg-gray-800 text-white text-center py-2 hover:bg-black transition-colors font-bold text-sm tracking-wider z-10">ACCESS FULL FILE</a>
            </div>
        </div>
        <!-- Card Detalhado -->
        <div id="detailed-view" class="hellboy-body" style="display: none;">
            <div class="hellboy-card w-full mx-auto p-6 pl-12">
                <img src="https://i.postimg.cc/XNQ858Pv/Background-19.png" class="watermark h-64 w-64" onerror="this.style.display='none'">
                <div class="flex justify-between items-start border-b-4 border-double border-gray-800 pb-2">
                    <div><h1 class="font-heading text-3xl text-gray-800 tracking-wider">AGENT IDENTIFICATION</h1><p class="font-heading text-sm text-gray-600">BUREAU FOR PARANORMAL RESEARCH & DEFENSE</p></div>
                    <div class="stamp font-heading">CLASSIFIED</div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4">
                    <div class="col-span-1 flex flex-col items-center">
                        <div class="profile-pic-container w-full"><img id="d-pic" src="" class="w-full h-auto profile-pic hellboy-card" onerror="this.src='https://placehold.co/200x250/6b7280/ffffff?text=AGENT'"></div>
                        <div class="grid grid-cols-3 gap-2 w-full mt-2 text-center">
                            <div><p class="data-label text-xs">HEIGHT</p><p id="d-height" class="data-value text-base"></p></div>
                            <div><p class="data-label text-xs">WEIGHT</p><p id="d-weight" class="data-value text-base"></p></div>
                            <div><p class="data-label text-xs">AGE</p><p id="d-age" class="data-value text-base"></p></div>
                        </div>
                        <div class="w-full h-12 border-b-2 border-gray-800 mt-4"></div>
                        <p class="data-label text-xs w-full text-left mt-1">SIGNATURE</p>
                        <div class="mt-4 w-full"><a href="#" onclick="toggleView(event)" class="block w-full bg-gray-700 text-white text-center py-2 tracking-widest hover:bg-gray-800 transition-colors font-heading text-sm">B.P.R.D. ID CARD</a></div>
                    </div>
                    <div class="md:col-span-2">
                        <div class="grid grid-cols-2 gap-x-6 gap-y-4">
                            <div class="col-span-2 data-field"><p class="data-label text-xs">NAME</p><p id="d-name" class="data-value"></p></div>
                            <div class="col-span-2 data-field"><p class="data-label text-xs">ORIGIN CLASSIFICATION</p><p id="d-origin" class="data-value"></p></div>
                            <div class="col-span-2 grid grid-cols-2 gap-x-6">
                                <div class="data-field"><p class="data-label text-xs">RECRUITMENT</p><p id="d-recruitment" class="data-value"></p></div>
                                <div class="data-field"><p class="data-label text-xs">LIFE BEFORE</p><p id="d-lifeBefore" class="data-value"></p></div>
                            </div>
                            <div class="col-span-2 grid grid-cols-7 gap-x-6">
                                <div class="col-span-3 data-field"><p class="data-label text-xs">DEPARTMENT</p><p id="d-department" class="data-value"></p></div>
                                <div class="col-span-3 data-field"><p class="data-label text-xs">ROLE</p><p id="d-role" class="data-value"></p></div>
                                <div class="col-span-1 data-field"><p class="data-label text-xs">LEVEL</p><p id="d-level" class="data-value"></p></div>
                            </div>
                        </div>
                        <div class="mt-6"><p class="data-label text-xs border-b border-gray-400 mb-2">ATTRIBUTES (MOD)</p><div class="flex flex-wrap justify-between gap-x-3 gap-y-1 text-sm" id="d-attributes"></div></div>
                        <div class="mt-6"><p class="data-label text-xs border-b border-gray-400 mb-2">PSYCHOLOGICAL ASSESSMENT</p><ul id="d-psych" class="text-sm font-bold text-red-800/90 space-y-1"></ul></div>
                        <div class="mt-6"><p class="data-label text-xs border-b border-gray-400 mb-2">DRIVE</p><p id="d-drive" class="text-sm font-bold"></p></div>
                    </div>
                </div>
                <div class="mt-6 pt-2 border-t-2 border-gray-700 flex items-center justify-between">
                    <p id="d-barcode" class="font-barcode text-4xl text-gray-800"></p>
                    <p class="font-heading text-xs text-gray-500 text-right">UNAUTHORIZED REPLICATION IS A<br>FEDERAL OFFENSE.</p>
                </div>
            </div>
        </div>
    </div>
    <div id="message-container"></div>
    <div class="mt-8"><a href="personagens.html" class="inline-block bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded transition-colors btn">Meus Personagens</a></div>

    <script src="auth.js"></script>
    <script>
        const cardContainer = document.getElementById('card-container');
        const messageContainer = document.getElementById('message-container');
        const simpleView = document.getElementById('simple-view');
        const detailedView = document.getElementById('detailed-view');
        
        function toggleView(event) {
            event.preventDefault();
            const isSimpleVisible = simpleView.style.display !== 'none';
            simpleView.style.display = isSimpleVisible ? 'none' : 'block';
            detailedView.style.display = isSimpleVisible ? 'block' : 'none';
        }

        function calculateModifier(score) {
            const mod = Math.floor((score - 10) / 2);
            return mod >= 0 ? `+${mod}` : mod;
        }

        function displayMessage(msg) {
            messageContainer.innerHTML = `<h1 class="text-white text-2xl text-center">${msg}</h1>`;
        }

        function populateViews(agent) {
             document.title = `B.P.R.D. Agent ID - ${agent.name.toUpperCase()}`;
            const profilePicture = agent.profilePic || 'https://placehold.co/200x250/6b7280/ffffff?text=AGENT';

            // --- Popular Card Simples ---
            document.getElementById('s-name').textContent = agent.name.toUpperCase();
            document.getElementById('s-role').textContent = agent.role.toUpperCase();
            document.getElementById('s-recruitment').textContent = agent.recruitment.toUpperCase();
            document.getElementById('s-level').textContent = agent.level;
            document.getElementById('s-pic').src = profilePicture;
            document.getElementById('s-barcode').textContent = `*BPRD${agent._id.toString().slice(-5)}RD*`;
            
            ['str', 'con', 'dex', 'int', 'wis', 'cha'].forEach(attr => {
                const score = agent.attributes[attr];
                const mod = calculateModifier(score);
                const element = document.getElementById(`s-${attr}`);
                element.innerHTML = `${score} <sup>(${mod})</sup>`;
                element.className = 'attribute-value ' + (score < 10 ? 'text-red-700' : 'text-gray-800');
            });

            // --- Popular Card Detalhado ---
            document.getElementById('d-name').textContent = agent.name.toUpperCase();
            document.getElementById('d-origin').textContent = agent.origin.toUpperCase();
            document.getElementById('d-recruitment').textContent = agent.recruitment.toUpperCase();
            document.getElementById('d-lifeBefore').textContent = agent.lifeBefore ? agent.lifeBefore.toUpperCase() : 'N/A';
            document.getElementById('d-department').textContent = agent.department.toUpperCase();
            document.getElementById('d-role').textContent = agent.role.toUpperCase();
            document.getElementById('d-level').textContent = agent.level;
            document.getElementById('d-pic').src = profilePicture;
            document.getElementById('d-age').textContent = agent.age || 'N/A';
            document.getElementById('d-height').textContent = agent.height ? `${agent.height}cm` : 'N/A';
            document.getElementById('d-weight').textContent = agent.weight ? `${agent.weight}kg` : 'N/A';
            document.getElementById('d-drive').textContent = agent.drive ? agent.drive.toUpperCase() : 'N/A';
            
            const consonants = agent.name.toUpperCase().replace(/[^B-DF-HJ-NP-TV-Z]/g, '').slice(0, 3);
            document.getElementById('d-barcode').textContent = `BPRD-${agent._id.toString().slice(-5)}-${consonants}`;

            const attributesContainer = document.getElementById('d-attributes');
            attributesContainer.innerHTML = '';
            ['con', 'str', 'dex', 'int', 'wis', 'cha'].forEach(attr => {
                 const score = agent.attributes[attr];
                 const mod = calculateModifier(score);
                 const p = document.createElement('p');
                 p.innerHTML = `<span class="font-bold">${attr.toUpperCase()}:</span> ${score} (${mod})`;
                 p.className = score < 10 ? 'text-red-700' : '';
                 attributesContainer.appendChild(p);
            });

            const psychList = document.getElementById('d-psych');
            psychList.innerHTML = '';
            agent.psych.forEach(item => {
                if (item) {
                    const li = document.createElement('li');
                    li.textContent = `> ${item.toUpperCase()}`;
                    psychList.appendChild(li);
                }
            });
            cardContainer.style.display = 'block';
        }

        async function fetchCharacter(id) {
            const token = localStorage.getItem('bprd_token');
            // O ideal seria uma rota GET /api/characters/:id que retornasse o personagem
            // se ele for público OU se pertencer ao usuário logado.
            // Por simplicidade, vamos buscar nas duas listas (públicos e meus).
            try {
                // Tenta buscar nos personagens do usuário
                if(token) {
                    const myRes = await fetch(`${API_URL}/characters/mine`, { headers: {'x-auth-token': token }});
                    if(myRes.ok) {
                        const myChars = await myRes.json();
                        const character = myChars.find(c => c._id === id);
                        if(character) return character;
                    }
                }
                // Se não achou, tenta buscar nos públicos
                const publicRes = await fetch(`${API_URL}/characters/public`);
                if(publicRes.ok) {
                    const publicChars = await publicRes.json();
                    const character = publicChars.find(c => c._id === id);
                    if(character) return character;
                }
                return null; // Não encontrou em nenhuma lista
            } catch (error) {
                console.error("Erro ao buscar personagem:", error);
                return null;
            }
        }

        window.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const agentId = params.get('id');

            if (!agentId) {
                displayMessage('ID do personagem não encontrado.');
                return;
            }

            const agent = await fetchCharacter(agentId);

            if (!agent) {
                displayMessage('Personagem não encontrado ou acesso negado.');
                return;
            }
            
            populateViews(agent);
        });
    </script>
</body>
</html>
