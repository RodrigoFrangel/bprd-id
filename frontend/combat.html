<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>B.P.R.D. - Rastreamento de Combate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="public/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Special+Elite&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --footer-height: 80px;
        }
        body { 
            background-color: #1a1a1a; 
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23333333' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            font-family: 'Roboto Condensed', sans-serif; 
            color: #f5f5f5;
            padding-bottom: var(--footer-height);
        }

        .font-special {
            font-family: 'Special Elite', monospace;
        }

        .btn {
            font-family: 'Roboto Condensed', sans-serif;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
        }

        .btn-primary {
            background-color: #b91c1c;
            border-color: #b91c1c;
        }

        .btn:hover {
            transform: translateY(-2px);
            filter: brightness(1.15);
        }
        
        .btn:disabled {
            background-color: #4b5563;
            border-color: #4b5563;
            cursor: not-allowed;
            transform: none;
            filter: brightness(0.8);
        }

        .control-btn {
            width: 48px;
            height: 48px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .character-card {
            background-color: #2d2d2d;
            border: 1px solid #444;
            transition: all 0.3s ease-in-out;
        }

        .character-card.is-turn {
            border-color: #ef4444; /* red-500 */
            background-color: #3f3f46;
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.3); /* Sombra vermelha sutil */
        }

        .hp-bar {
            background-color: #28a745; 
            transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;
        }
        .hp-bar.is-low { background-color: #f59e0b; }
        .hp-bar.is-critical { background-color: #dc2626; }
        .hp-bar.has-temp-hp { background-color: #3b82f6; } /* Cor para HP temporário */
        .hp-bar-container { background-color: #1a1a1a; }
        .hp-value.editable:hover { cursor: pointer; background-color: rgba(255,255,255,0.1); border-radius: 4px; }
        .hp-value.has-temp-hp {
            color: #60a5fa; /* Cor do texto para HP temporário */
            text-shadow: 0 0 5px rgba(96, 165, 250, 0.7);
        }
        .initiative-value.editable:hover { cursor: pointer; background-color: rgba(255,255,255,0.1); border-radius: 8px; }


        @keyframes pulse {
            50% { opacity: 0.7; }
        }

        .turn-indicator {
            animation: pulse 2s infinite ease-in-out;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.4); /* Sombra vermelha sutil */
        }
        
        .app-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--footer-height);
            z-index: 50;
        }
        
        .footer-action-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px; /* rounded-full */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            font-size: 1.25rem; /* Icon size */
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto max-w-4xl p-4 sm:p-6">
        <header class="flex items-center justify-between mb-8">
            <a href="javascript:history.back()" title="Voltar" class="btn control-btn bg-gray-700 hover:bg-gray-600 text-white">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1 class="font-special text-4xl sm:text-6xl text-red-600 text-center tracking-wider">Combate</h1>
            <div class="w-12 h-12"></div>
        </header>

        <div id="character-list" class="space-y-3">
        </div>
    </div>
    
    <footer class="app-footer">
        <div id="footer-actions" class="w-full h-full max-w-4xl mx-auto flex items-center justify-center gap-4 px-4">
        </div>
    </footer>


    <script src="auth.js"></script>
    <script>
        const characterList = document.getElementById('character-list');
        const footerActions = document.getElementById('footer-actions');
        let currentCharacters = [];

        async function fetchCharacters() {
            try {
                const res = await fetch(`${API_URL}/characters/main`, {
                    headers: { 'x-auth-token': localStorage.getItem('bprd_token') }
                });
                if (!res.ok) {
                    throw new Error('Falha ao carregar personagens para o combate.');
                }
                const characters = await res.json();
                currentCharacters = characters;
                renderCharacters(characters);
            } catch (err) {
                console.error('Erro ao buscar personagens:', err);
                characterList.innerHTML = `<p class="text-center text-red-500">${err.message}</p>`;
            }
        }

        function renderCharacters(characters) {
            characterList.innerHTML = '';
            const loggedInUserId = getLoggedInUserId();
            
            characters.sort((a, b) => (b.initiative ?? -1) - (a.initiative ?? -1));

            if (characters.length === 0) {
                characterList.innerHTML = `<p class="text-center text-gray-400">Nenhum personagem principal definido para combate.</p>`;
            } else {
                characters.forEach(character => {
                    const ownerId = character.userId?._id || character.userId;
                    const isOwner = loggedInUserId && ownerId && ownerId === loggedInUserId;

                    const card = document.createElement('div');
                    card.className = `character-card rounded-lg p-3 flex items-center gap-3 ${character.isTurn ? 'is-turn' : ''}`;
                    
                    const hasTempHP = character.currentHP > character.hitPoints;
                    const hpPercentage = hasTempHP ? 100 : (character.currentHP / character.hitPoints) * 100;
                    
                    let hpBarClass = 'hp-bar';
                    if (hasTempHP) {
                        hpBarClass += ' has-temp-hp';
                    } else {
                        if (hpPercentage <= 50) hpBarClass += ' is-low';
                        if (hpPercentage <= 25) hpBarClass += ' is-critical';
                    }
                    
                    const turnIndicatorHTML = character.isTurn ? `<div class="absolute -top-1.5 -left-1.5 w-3 h-3 bg-red-500 rounded-full turn-indicator"></div>` : '';
                    const formattedName = formatCharacterName(character.name);
                    
                    let hpValueClass = isOwner ? 'hp-value editable' : 'hp-value';
                    if (hasTempHP) {
                        hpValueClass += ' has-temp-hp';
                    }
                    
                    const dexModifier = Math.floor(((character.attributes?.dex || 10) - 10) / 2);
                    const armorClass = 10 + dexModifier;

                    card.innerHTML = `
                        <!-- Col 1: Image -->
                        <div class="relative flex-shrink-0">
                            ${turnIndicatorHTML}
                            <img src="${character.profilePic || 'https://placehold.co/64x64/2d2d2d/f5f5f5?text=BPRD'}" alt="Foto de ${character.name}" class="w-14 h-14 rounded-full object-cover border-2 border-gray-600">
                        </div>

                        <!-- Col 2: Info (Name, AC, HP) -->
                        <div class="w-full">
                            <div class="flex items-start gap-2">
                                <h2 class="font-special text-lg text-white truncate" title="${character.name}">${formattedName}</h2>
                                <div class="flex items-center gap-1 text-sm flex-shrink-0">
                                    <i class="fas fa-shield-alt text-gray-400"></i>
                                    <span class="font-bold text-white">${armorClass}</span>
                                </div>
                            </div>
                            <div class="mt-1">
                                <div class="flex items-center gap-2">
                                    <div class="w-full bg-gray-800 rounded-full h-1.5">
                                        <div class="${hpBarClass} h-1.5 rounded-full transition-all duration-300" style="width: ${hpPercentage}%;"></div>
                                    </div>
                                    <p class="${hpValueClass} text-xs font-bold whitespace-nowrap" data-char-id="${character._id}">${character.currentHP ?? 'N/A'}/${character.hitPoints ?? 'N/A'}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Col 3: Initiative -->
                        <div class="text-center flex-shrink-0 pl-4">
                             <p class="${isOwner ? 'initiative-value editable' : 'initiative-value'} text-5xl font-bold text-gray-200 px-2" data-char-id="${character._id}">${character.initiative !== null ? character.initiative : '—'}</p>
                        </div>
                    `;
                    characterList.appendChild(card);
                });
            }
            
            renderFooterActions(characters);
        }
        
        function renderFooterActions(characters) {
            footerActions.innerHTML = '';
            
            const activeCharacter = characters.find(c => c.isTurn);

            const mapLink = document.createElement('a');
            mapLink.href = 'map.html';
            mapLink.title = 'Mapa Tático';
            mapLink.className = 'btn bg-gray-700 hover:bg-gray-600 text-white control-btn';
            mapLink.innerHTML = '<i class="fas fa-map-marked-alt"></i>';

            const endTurnBtn = document.createElement('button');
            endTurnBtn.className = 'btn btn-primary text-white font-bold py-3 px-5 rounded-lg flex-grow flex items-center justify-center gap-2 text-sm max-w-xs footer-action-btn';
            endTurnBtn.innerHTML = 'Encerrar Turno <i class="fas fa-arrow-right"></i>';
            endTurnBtn.disabled = !activeCharacter; // Permitir encerrar o turno de qualquer um para testes
            endTurnBtn.addEventListener('click', endTurn);
            
            footerActions.appendChild(mapLink);
            footerActions.appendChild(endTurnBtn);
        }

        function formatCharacterName(fullName) {
            if (!fullName) return '';
            const quoteMatch = fullName.match(/"(.*?)"/);
            return (quoteMatch && quoteMatch[1]) ? quoteMatch[1] : fullName.split(' ')[0];
        }
        
        characterList.addEventListener('click', (e) => {
            if (e.target.classList.contains('editable')) {
                if (e.target.classList.contains('hp-value')) {
                    makeHpEditable(e.target);
                } else if (e.target.classList.contains('initiative-value')) {
                    makeInitiativeEditable(e.target);
                }
            }
        });

        function makeHpEditable(hpElement) {
            const charId = hpElement.dataset.charId;
            const character = currentCharacters.find(c => c._id === charId);
            if (!character) return;

            const originalText = hpElement.textContent;
            const input = document.createElement('input');
            input.type = 'number';
            input.value = character.currentHP;
            input.className = 'bg-gray-700 text-white text-center font-mono text-xs font-bold rounded w-16';
            
            hpElement.replaceWith(input);
            input.focus();
            input.select();

            const saveChanges = async () => {
                let newHP = parseInt(input.value, 10);
                if (isNaN(newHP)) newHP = character.currentHP;
                newHP = Math.max(0, newHP);

                try {
                    await updateHP(charId, newHP);
                    await fetchCharacters();
                } catch (error) {
                    console.error("Erro ao atualizar HP:", error);
                    input.replaceWith(hpElement);
                    hpElement.textContent = originalText;
                }
            };

            input.addEventListener('blur', saveChanges);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') input.blur();
                if (e.key === 'Escape') {
                    input.replaceWith(hpElement);
                    hpElement.textContent = originalText;
                }
            });
        }

        function makeInitiativeEditable(initiativeElement) {
            const charId = initiativeElement.dataset.charId;
            const character = currentCharacters.find(c => c._id === charId);
            if (!character) return;

            const originalText = initiativeElement.textContent;
            const input = document.createElement('input');
            input.type = 'number';
            input.value = character.initiative;
            input.className = 'bg-gray-700 text-white text-center font-bold rounded w-24 text-5xl';
            
            initiativeElement.replaceWith(input);
            input.focus();
            input.select();

            const saveChanges = async () => {
                let newInitiative = parseInt(input.value, 10);
                if (isNaN(newInitiative)) newInitiative = character.initiative;

                try {
                    await updateInitiative(charId, newInitiative);
                    await fetchCharacters();
                } catch (error) {
                    console.error("Erro ao atualizar Iniciativa:", error);
                    input.replaceWith(initiativeElement);
                    initiativeElement.textContent = originalText;
                }
            };

            input.addEventListener('blur', saveChanges);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') input.blur();
                if (e.key === 'Escape') {
                    input.replaceWith(initiativeElement);
                    initiativeElement.textContent = originalText;
                }
            });
        }

        async function updateHP(id, newHP) {
            const token = localStorage.getItem('bprd_token');
            const res = await fetch(`${API_URL}/combat/hp/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
                body: JSON.stringify({ currentHP: newHP })
            });
            if (!res.ok) {
                const errorData = await res.json().catch(() => ({ msg: `Erro ${res.status}: Falha no servidor.` }));
                throw new Error(errorData.msg);
            }
        }

        async function updateInitiative(id, newInitiative) {
            const token = localStorage.getItem('bprd_token');
            try {
                const res = await fetch(`${API_URL}/combat/initiative/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
                    body: JSON.stringify({ initiative: newInitiative })
                });
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({ msg: `Erro ${res.status}: Falha no servidor.` }));
                    throw new Error(errorData.msg);
                }
            } catch (err) {
                console.error(err);
                alert(err.message);
                throw err;
            }
        }

        async function endTurn() {
            try {
                const res = await fetch(`${API_URL}/combat/end-turn`, {
                    method: 'PUT',
                    headers: { 'x-auth-token': localStorage.getItem('bprd_token') }
                });
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({ msg: `Erro ${res.status}: Falha no servidor.` }));
                    throw new Error(errorData.msg);
                }
                await fetchCharacters();
            } catch (err) {
                console.error(err);
                alert(err.message);
            }
        }

        fetchCharacters();
    </script>
</body>
</html>
