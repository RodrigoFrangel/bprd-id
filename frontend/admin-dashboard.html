<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B.P.R.D. - Painel de Administração</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="public/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Special+Elite&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { 
            background-color: #1a1a1a; /* Cor de fundo ajustada */
            font-family: 'Roboto Condensed', sans-serif; 
            color: #f5f5f5;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23333333' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .font-special { font-family: 'Special Elite', monospace; }
        .form-select { 
            background-color: #374151; 
            border-color: #4b5563;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover:not(:disabled) {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        .modal-overlay {
            background-color: rgba(10, 10, 10, 0.7);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-box {
            transition: all 0.3s ease-in-out;
        }
        .form-input {
             background-color: #1a1a1a; 
             border: 1px solid #555;
        }
        .user-card {
            background-color: rgba(31, 41, 55, 0.5); /* bg-gray-800 com opacidade */
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .details-arrow {
            transition: transform 0.2s ease-in-out;
        }
        details[open] .details-arrow {
            transform: rotate(180deg);
        }
        summary::-webkit-details-marker {
            display: none;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="container mx-auto max-w-4xl">
        <header class="flex items-center justify-between mb-8">
             <a href="index.html" title="Voltar" class="btn bg-gray-700 hover:bg-gray-600 text-white w-12 h-12 rounded-full flex items-center justify-center">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1 class="font-special text-3xl sm:text-5xl text-red-600 text-center">Administração</h1>
            <div class="w-12 h-12"></div>
        </header>

        <main id="user-list-container" class="space-y-3">
            <!-- Os cards dos usuários serão inseridos aqui -->
            <div id="loading-msg" class="text-center text-gray-400 p-8">A carregar utilizadores...</div>
        </main>
    </div>

    <!-- Modal de Confirmação -->
    <div id="delete-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-box bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 text-center">
            <h3 class="text-xl font-bold mb-2">Confirmar Exclusão</h3>
            <p class="text-gray-300 mb-4">Tem a certeza de que quer eliminar este utilizador e todos os seus personagens? Esta ação é irreversível.</p>
            <div class="my-4 text-left">
                <label for="delete-confirm-input" class="text-sm text-gray-400 block mb-2">Para confirmar, digite <strong class="text-red-500">DELETE</strong> abaixo:</label>
                <input type="text" id="delete-confirm-input" class="form-input text-white text-center w-full p-2 rounded-lg tracking-widest font-bold" autocomplete="off">
            </div>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-btn" class="btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
                <button id="confirm-delete-btn" class="btn bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Confirmar</button>
            </div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userListContainer = document.getElementById('user-list-container');
            const loadingMsg = document.getElementById('loading-msg');
            const deleteModal = document.getElementById('delete-modal');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const deleteConfirmInput = document.getElementById('delete-confirm-input');
            
            const token = localStorage.getItem('bprd_token');
            const loggedInUser = getDecodedToken()?.user;
            let userToDeleteId = null;

            // Proteção da página
            if (!loggedInUser || loggedInUser.role !== 'Admin') {
                document.body.innerHTML = `<div class="text-center text-red-500 p-10"><h1>Acesso Negado</h1><p>Esta área é restrita para administradores.</p><a href="index.html" class="inline-block mt-4 bg-gray-700 p-2 rounded-lg">Voltar</a></div>`;
                return;
            }

            async function fetchUsers() {
                try {
                    const response = await fetch(`${API_URL}/admin/users`, {
                        headers: { 'x-auth-token': token }
                    });
                    if (!response.ok) throw new Error('Não foi possível carregar os utilizadores.');
                    const users = await response.json();
                    renderUsers(users);
                } catch (error) {
                    loadingMsg.textContent = error.message;
                }
            }
            
            function renderUsers(users) {
                userListContainer.innerHTML = ''; // Limpa antes de renderizar
                if (users.length === 0) {
                    userListContainer.innerHTML = '<p class="text-center text-gray-400 p-8">Nenhum utilizador encontrado.</p>';
                    return;
                }
                
                users.forEach(user => {
                    const isCurrentUser = user._id === loggedInUser.id;
                    const userCard = document.createElement('div');
                    userCard.className = 'user-card rounded-lg overflow-hidden';

                    const roleOptions = ['Player', 'DM', 'Admin']
                        .map(r => `<option value="${r}" ${user.role === r ? 'selected' : ''}>${r}</option>`)
                        .join('');
                    
                    userCard.innerHTML = `
                        <details>
                            <summary class="p-4 flex justify-between items-center cursor-pointer list-none hover:bg-white/5 transition-colors duration-200">
                                <div>
                                    <h2 class="text-lg font-bold text-white">${user.username}</h2>
                                    <p class="text-sm text-gray-400">${user.email}</p>
                                </div>
                                <i class="fas fa-chevron-down details-arrow text-gray-400"></i>
                            </summary>
                            <div class="p-4 border-t border-white/10 bg-black/20 flex flex-col items-start gap-2">
                                <label for="role-select-${user._id}" class="text-sm text-gray-300">Função:</label>
                                <div class="w-full flex items-center gap-4">
                                    <select id="role-select-${user._id}" data-userid="${user._id}" class="role-select form-select rounded-lg p-2 w-full sm:w-auto flex-grow text-white" ${isCurrentUser ? 'disabled' : ''}>
                                        ${roleOptions}
                                    </select>
                                    <button data-userid="${user._id}" class="delete-btn btn bg-red-700 hover:bg-red-600 text-white w-10 h-10 rounded-lg flex-shrink-0 flex items-center justify-center disabled:opacity-50 disabled:bg-gray-600 disabled:cursor-not-allowed" ${isCurrentUser ? 'disabled' : ''}>
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </details>
                    `;
                    userListContainer.appendChild(userCard);
                });
            }

            async function updateUserRole(userId, newRole) {
                try {
                    const response = await fetch(`${API_URL}/admin/users/${userId}/role`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
                        body: JSON.stringify({ role: newRole })
                    });
                    if (!response.ok) {
                         const err = await response.json();
                         throw new Error(err.msg || 'Falha ao atualizar a função.');
                    }
                } catch (error) {
                    console.error(`Erro: ${error.message}`);
                    fetchUsers(); 
                }
            }

            async function deleteUser(userId) {
                try {
                    const response = await fetch(`${API_URL}/admin/users/${userId}`, {
                        method: 'DELETE',
                        headers: { 'x-auth-token': token }
                    });
                    if (!response.ok) {
                         const err = await response.json();
                         throw new Error(err.msg || 'Falha ao eliminar o utilizador.');
                    }
                    fetchUsers();
                } catch (error) {
                    console.error(`Erro: ${error.message}`);
                }
            }
            
            function closeModalAndReset() {
                userToDeleteId = null;
                deleteConfirmInput.value = '';
                confirmDeleteBtn.disabled = true;
                deleteModal.classList.add('hidden');
            }

            userListContainer.addEventListener('change', (e) => {
                if (e.target.classList.contains('role-select')) {
                    const userId = e.target.dataset.userid;
                    const newRole = e.target.value;
                    updateUserRole(userId, newRole);
                }
            });

            userListContainer.addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.delete-btn');
                if (deleteButton) {
                    userToDeleteId = deleteButton.dataset.userid;
                    deleteModal.classList.remove('hidden');
                }
            });

            cancelDeleteBtn.addEventListener('click', closeModalAndReset);

            confirmDeleteBtn.addEventListener('click', () => {
                if (userToDeleteId) {
                    deleteUser(userToDeleteId);
                }
                closeModalAndReset();
            });

            deleteConfirmInput.addEventListener('input', () => {
                confirmDeleteBtn.disabled = deleteConfirmInput.value !== 'DELETE';
            });

            fetchUsers();
        });
    </script>
</body>
</html>
